<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Paper People Weather Display</title>
<style>
  :root {
    --brand-blue: #005BAA;
    --brand-green: #4CAF50;
    --bg-dark: #121212;
    --text-light: #f5f5f5;
  }
  html, body {
    margin: 0; padding: 0; height: 100%; width: 100%;
    background: var(--bg-dark); color: var(--text-light);
    font-family: 'Arial Black', sans-serif; overflow: hidden;
  }
  .container {
    display: flex; flex-direction: column; align-items: center;
    height: 100%; width: 100%;
  }
  .logo img { max-height: 80px; margin: 0.6em 0; }
  .clock { font-size: 4em; color: var(--brand-blue); margin: 0.1em 0; }
  .day { font-size: 2em; color: var(--brand-green); margin: 0 0 0.2em; }
  .date { font-size: 1.8em; color: #ccc; margin-bottom: 0.6em; }

  .weather {
    flex: 1;
    width: 100%;
    max-width: 1920px;
    padding: 0 1em 1em;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-sizing: border-box;
  }
  .current {
    display: flex; flex-direction: row; align-items: center; gap: 1em; margin-bottom: 1em;
  }
  .current img { height: 100px; width: 100px; }
  .current-temp { font-size: 4em; }
  .current-desc { font-size: 1.4em; text-transform: capitalize; }

  .forecast {
    display: flex; justify-content: center; gap: 1em; flex-wrap: wrap;
  }
  .daycard {
    background: #1e1e1e;
    border-radius: 8px;
    padding: 0.6em 1em;
    text-align: center;
    min-width: 110px;
  }
  .daycard img { height: 45px; width: 45px; }
  .daycard .label { font-size: 1.2em; margin-top: 0.4em; }
  .daycard .temp { font-size: 1.1em; margin-top: 0.3em; }
  .daycard .pop { font-size: 1em; margin-top: 0.3em; color: #9cf; }

  .alerts {
    background: #ff0000;
    color: white;
    padding: 0.5em 1em;
    margin: 1em auto;
    border-radius: 6px;
    font-size: 1.2em;
    max-width: 80%;
    text-align: center;
    overflow: hidden;
    white-space: nowrap;
    position: relative;
  }
  .alerts span {
    display: inline-block;
    position: absolute;
    animation: scroll-left 20s linear infinite;
  }
  @keyframes scroll-left {
    0% { left: 100%; }
    100% { left: -100%; }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="logo"><img src="paper-people-logo.png" alt="The Paper People logo"></div>
    <div class="clock" id="clock">--:--:--</div>
    <div class="day" id="day">Loading…</div>
    <div class="date" id="date">---</div>
    <div class="weather" id="weather"></div>
    <div class="alerts" id="alerts"><span>No active alerts.</span></div>
    <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
  </div>

<script>
const PROXY_URL = "https://weather-signage.onrender.com/api/weather";

function updateClock() {
  const now = new Date();
  let h = now.getHours();
  const m = String(now.getMinutes()).padStart(2, '0');
  const s = String(now.getSeconds()).padStart(2, '0');
  const ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  document.getElementById('clock').textContent = `${h}:${m}:${s} ${ampm}`;
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('day').textContent = days[now.getDay()];
  document.getElementById('date').textContent = `${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
}
setInterval(updateClock, 1000); updateClock();

async function fetchWeather() {
  try {
    console.log("Fetching weather...");
    const res = await fetch(PROXY_URL);
    if (!res.ok) throw new Error(`API response error: ${res.status}`);
    const data = await res.json();
    console.log("Weather data:", data);
    renderWeather(data);
    renderAlerts(data);
  } catch (e) {
    console.error("Failed to fetch weather data:", e);
    document.getElementById("weather").innerHTML = "<p style='color:red'>Weather data unavailable</p>";
  }
}

function iconUrl(iconCode) {
  return `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
}

function renderWeather(data) {
  const container = document.getElementById("weather");
  if (!data || !data.current || !data.daily) {
    container.innerHTML = "<p style='color:red'>Weather data missing</p>";
    return;
  }

  const current = data.current;
  const currentHTML = `
    <div class="current">
      <img src="${iconUrl(current.weather[0].icon)}" alt="">
      <div>
        <div class="current-temp">${Math.round(current.temp)}°</div>
        <div class="current-desc">${current.weather[0].description}</div>
      </div>
    </div>`;

  const forecastHTML = data.daily.slice(1, 6).map(day => {
    const date = new Date(day.dt * 1000);
    const label = date.toLocaleDateString("en-US", { weekday: "short" });
    const pop = Math.round((day.pop || 0) * 100);

    let icon = day.weather[0].icon;
    const main = day.weather[0].main.toLowerCase();
    if (pop >= 50) {
      if (main.includes("snow")) {
        icon = "13d";
      } else if (main.includes("rain") || main.includes("drizzle")) {
        icon = "10d";
      } else {
        icon = "09d";
      }
    }

    return `
      <div class="daycard">
        <div>${label}</div>
        <img src="${iconUrl(icon)}" alt="">
        <div class="temp">${Math.round(day.temp.max)}° / ${Math.round(day.temp.min)}°</div>
        <div class="pop">Precip: ${pop}%</div>
        <div class="label">${day.weather[0].main}</div>
      </div>`;
  }).join("");

  container.innerHTML = currentHTML + `<div class="forecast">${forecastHTML}</div>`;
}

function renderAlerts(data) {
  const alertsBox = document.getElementById("alerts");
  const alertSound = document.getElementById("alertSound");
  if (data.alerts && data.alerts.length > 0) {
    const fullText = data.alerts.map(a => `${a.event}: ${a.description.split("\n")[0]}`).join(" • ");
    alertsBox.innerHTML = `<span>${fullText}</span>`;
    alertSound.play().catch(e => console.log("Alert sound error:", e));
  } else {
    alertsBox.innerHTML = "<span>No active alerts.</span>";
  }
}

fetchWeather();
setInterval(fetchWeather, 15 * 60 * 1000);
setTimeout(() => location.reload(), 60 * 60 * 1000);
</script>
</body>
</html>
